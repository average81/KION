# KION
Видеоаналитика фильмов  
Текущий проект создан для первичной аналитики фильмов: разбиения фильма на сцены, трекинг актеров, 
определение частоты монтажа и определение динамики сцен.

## Разворачивание окружения  
Было использовано окружение conda с python3.9.
Для работы pytorch на мощностях видеокарты было установлено окружение NVIDIA CUDA 11.8 и библиотеки cuDnn 9.11.
Не следует использовать виртуальные среды venv, если нужна поддержка GPU ускорителя в библиотеке dlib 
(в них симеются трудности сборки dlib с поддержкой CUDA). 
В текущем проекте было использовано виртуальное окружение conda.

### Последовательность установки  
#### Установка в виртуальное окружение
Для установки используемых библиотек нужных версий выполните команду в рабочей папке проекта:
pip install -r requirements.txt.
Отдельно установите pytorch, исходя из особенной платформы, на которой разворачивается проект.
Установка pytorch:
Перейдите на сайт https://pytorch.org/get-started/locally/ и выберите ссылку "install previous versions of PyTorch":
![img.png](img.png)  
На открывшейся странице нужно выбрать подходящий вариант установки PyTorch2.0.1 (в зависимости от имеющейся ОС и версии CUDA).
Далее нужно установить библиотеку Dlib. Возможна установка библиотеки только с поддержкой CPU командой  
`pip install dlib`  
Но при наличии GPU ускорителя лучше установить dlib с поддержкой GPU.  
Для этого нужно  выполнить следующую команду:  
```conda install conda-forge::dlib```  
Для установки поддержки работы с субтитрами нужна библиотека spacy.
Лучше всего установить его следующей командой:
```conda install conda-forge::spacy```  
После этого нужно установить поддержку русского языка для этой библиотеки командой:
```python -m spacy download ru_core_news_md```
#### Установка в докер


## Запуск проекта  
Запуск анализа видео запускается командой:  
`python shorts.py --video \<input video> [--output_dir /data][-base_update]`  
Результатом работы будет набор файлов шотов фильма в папке /data/shots, набор файлов сцен в папке /data/scenes,
набор файлов шотов с разметкой актеров в папке /data/shaped_shorts, а также таблицы с данными трекера по каждому шоту
в папке /data/shaped_shorts. Если выходная директория не задана, она создается в папке с исходным файлом.  
Флаг -base_update в команде принудительно запускает обновление базы данных дескрипторов лиц актеров. Требуется указывать его
при изменении датасета лиц актеров (после добавления или удаления изображений)
Для визуализации результатов работы необходимо вызвать команду:
``  
