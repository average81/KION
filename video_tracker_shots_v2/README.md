# Video Tracker Shots v2

Библиотека для трекинга людей в видео с разбивкой на шоты и сохранением результатов в структурированном виде.

## Установка

```bash
pip install -r requirements.txt
```

## Быстрый старт

Для запуска обработки видео используйте:

```bash
python video_tracker_shots_v2/optimized_tracker.py [input_video.mp4]
```

- Если аргумент не указан, по умолчанию используется файл `mister-i-missis-smit-2005_1.mkv`.
- Все выходные данные сохраняются в папку `output/`.

## Структура выходных данных

```
output/
├── shorts/           # Видео шотов без разметки (shot_000.mp4, ...)
├── shaped_shorts/    # Видео шотов с разметкой (shot_000.mp4, ...) и общий CSV
│   └── people_tracking_results.csv
├── pictures/         # Фото людей по шотам и ID (shot_000/ID_000/shot_000_frame_000001.jpg, ...)
└── scenes/           # (резерв, пока не используется)
```

- **shorts/** — видео каждого шота без разметки.
- **shaped_shorts/** — видео каждого шота с разметкой (рамки, ID) и один общий CSV-файл с треками по всем шотам.
- **pictures/** — фотографии людей, разбитые по шотам и ID.
- **scenes/** — резерв для будущей работы со сценами.

## Особенности

- Используется YOLOv8 (по умолчанию yolov8n.pt) — только класс "person" (люди).
- Трекинг с интерполяцией и сбросом при смене сцены.
- CSV-файл содержит все треки по всем шотам: shot_id, frame, object_id, x1, y1, x2, y2, confidence.
- Номер шота отображается на каждом видео с разметкой.
- Папки с фото создаются только если есть хотя бы одно фото.
- Перед запуском все выходные папки очищаются автоматически.

## Пример кода для использования как библиотеки

```python
from video_tracker_shots_v2.optimized_tracker import ShotsVideoProcessor

processor = ShotsVideoProcessor()
processor.process_video_with_shots("input_video.mp4", "output_video.mp4")
``` 

# Пайплайн обработки видео

## Общий порядок работы

1. **Детекция сцен (шотов)**
   - Видео предварительно разбивается на сцены (шоты) с помощью детектора смен сцен.
   - Результат сохраняется в файл `scene_analysis_optimized.csv` (колонки: scene, start_frame, end_frame, duration_seconds).

2. **Обработка каждого шота**
   - Для каждого шота (сцены) из CSV:
     - Вырезается соответствующий фрагмент видео и сохраняется в папку `shorts/`.
     - Для каждого кадра шота:
       - Детектируются люди (YOLOv8, только класс "person").
       - Ведётся трекинг объектов (ID, координаты, уверенность, кадр).
       - Сохраняются фото людей (по условиям: первое появление и далее каждые N кадров) в папку `photos/shot_xx/ID_xxx/`.
       - Ведётся запись данных в общий CSV (`people_tracking_results.csv`): shot_id, frame, object_id, bbox, conf и т.д.
       - На кадр накладываются рамки и подписи ID внутри рамки.
     - Собирается видео с разметкой и сохраняется в `shaped_shorts/`.

3. **Структура выходных данных**
   - `shorts/` — исходные видео-шоты без разметки.
   - `shaped_shorts/` — видео-шоты с разметкой (рамки, ID).
   - `photos/shot_xx/ID_xxx/` — фото людей по шотам и ID.
   - `people_tracking_results.csv` — общий CSV с результатами трекинга по всем шотам.
   - `output/scene_analysis_optimized.csv` — CSV с разбивкой на сцены (шоты).

## Особенности
- Трекинг и детекция выполняются отдельно для каждого шота, ID не перескакивают между шотами.
- Фото людей сохраняются только если объект реально присутствует в кадре.
- Все выходные данные структурированы по папкам для удобства анализа и повторной обработки. 